<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paiement ‚Äî Formation Trading</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/styles.css" />
  <script src="https://js.stripe.com/v3"></script>

  <!-- Styles sp√©cifiques √† la page paiement -->
  <style>
    /* Wrapper commun aux inputs du site */
    .input {
      height: 52px;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      background: #fff;
      padding: 0 14px;
      display: flex;
      align-items: center;
      box-sizing: border-box;
      width: 100%;
    }
    .input:focus-within {
      border-color: #111827;
      box-shadow: 0 0 0 1px #111827;
    }
    /* Stripe dans le wrapper : occupe tout l‚Äôespace */
    .input--stripe #card-element,
    .input--stripe .StripeElement,
    .input--stripe iframe {
      width: 100% !important;
      height: 100% !important;
    }
    /* Message d‚Äôinfo/erreur */
    #messages { min-height: 20px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <nav class="nav">
        <div class="brand">
          <span class="badge" style="width:36px;height:36px"></span>
          <span>Marque</span>
        </div>
        <div class="pills">
          <a class="badge" href="/index.html">Accueil</a>
          <a class="badge" href="/programme.html">Programme</a>
          <a class="badge" href="/temoignages.html">T√©moignages</a>
          <a class="badge" href="/faq.html">FAQ</a>
        </div>
        <a class="button" href="/paiement.html">Commencer</a>
      </nav>
    </div>
  </header>

  <!-- Section Paiement -->
  <main class="section">
    <div class="container">
      <div class="grid">
        <!-- Bloc paiement -->
        <section class="col-7">
          <h1>Paiement s√©curis√©</h1>

          <div class="card dashed">
            <h2>Payez en un geste</h2>
            <div id="payment-request-button" style="margin:16px 0;"></div>
            <p class="note">
              Apple Pay (Safari/iOS/macOS) ou Google Pay (Chrome/Android) s‚Äôaffiche automatiquement si disponible.
            </p>
          </div>

          <div style="height:16px"></div>

          <div class="card dashed">
            <h2>Ou par carte</h2>

            <!-- Wrapper input au style du site -->
            <div class="input input--stripe" id="card-wrapper">
              <div id="card-element"></div>
            </div>

            <button id="pay" class="button" style="margin-top:16px">Payer et acc√©der</button>
            <div id="messages" class="note" style="margin-top:8px"></div>
          </div>

          <p class="note" style="margin-top:12px">
            Garantie 14 jours. Paiement s√©curis√© via Stripe (3D Secure). Le trading comporte des risques de perte en capital.
          </p>
        </section>

        <!-- R√©capitulatif commande -->
        <aside class="col-5">
          <div class="card">
            <h3 style="margin:0 0 8px">Votre commande</h3>
            <p>Formation Trading ‚Äî Acc√®s complet</p>
            <div class="mock" style="height:120px; margin:16px 0;"></div>
            <div style="border-top:1px solid var(--stroke); padding-top:12px">
              <div style="display:flex; justify-content:space-between">
                <span>Total</span>
                <strong id="order-total">‚Äî</strong>
              </div>
              <div class="note">Taxes incluses</div>
            </div>
          </div>
          <div class="pills" style="margin-top:12px">
            <span class="pill">Visa</span>
            <span class="pill">Mastercard</span>
            <span class="pill">Apple Pay</span>
            <span class="pill">Google Pay</span>
            <span class="pill">Stripe</span>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="section" style="padding-top:48px;">
    <div class="container">
      <div class="pills">
        <span class="pill">Mentions l√©gales</span>
        <span class="pill">Conditions g√©n√©rales</span>
        <span class="pill">Remboursement 14j</span>
        <span class="pill">Risques trading</span>
      </div>
    </div>
  </footer>

  <script>
    // üîó Backend Render (prod). En dev local : "http://localhost:4242"
    const API_BASE_URL = "https://trading-sitea.onrender.com";

    const messages = (m) => {
      document.getElementById('messages').textContent = m || "";
    };

    async function init(){
      // 1) R√©cup config (cl√© publique + prix)
      const cfg = await fetch(API_BASE_URL + "/config").then(r => r.json());
      const stripe = Stripe(cfg.publishableKey);

      // Montant en centimes (entier) retourn√© par le backend
      const cents = Number(cfg.amount);           // ex. 36000 pour 360,00 ‚Ç¨
      const currency = cfg.currency || "eur";

      // Affichage en euros
      document.getElementById("order-total").textContent =
        new Intl.NumberFormat("fr-FR",{ style:"currency", currency }).format(cents/100);

      // 2) Wallets (Apple Pay / Google Pay) ‚Äî ATTENTION: montant en CENTIMES
      const pr = stripe.paymentRequest({
        country: "FR",
        currency,
        total: { label: "Formation Trading", amount: cents },
        requestPayerName: true,
        requestPayerEmail: true
      });
      const elements = stripe.elements();
      const prButton = elements.create("paymentRequestButton", {
        paymentRequest: pr,
        style: { paymentRequestButton: { type: "default" } }
      });
      const canPay = await pr.canMakePayment();
      if (canPay) prButton.mount("#payment-request-button");
      else document.getElementById("payment-request-button").style.display = "none";

      // 3) Carte bancaire (Stripe Elements) ‚Äî style lisible
      const card = elements.create("card", {
        style: {
          base: {
            fontSize: "16px",
            color: "#111827",
            fontFamily: "Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif",
            "::placeholder": { color: "#9ca3af" }
          },
          invalid: { color: "#dc2626" }
        }
      });
      card.mount("#card-element");

      // 4) Paiement par carte
      const btn = document.getElementById("pay");
      btn.addEventListener("click", async () => {
        try {
          btn.disabled = true;
          messages("Cr√©ation du paiement‚Ä¶");
          const r = await fetch(API_BASE_URL + "/create-payment-intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}) // place pour metadata si besoin
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data?.error?.message || "Erreur serveur");

          const { error } = await stripe.confirmCardPayment(data.clientSecret, {
            payment_method: { card }
          });

          if (error) throw error;

          messages("Paiement r√©ussi. Redirection‚Ä¶");
          setTimeout(() => window.location = "success.html", 1000);
        } catch (e) {
          messages(e.message || "Paiement refus√©.");
          btn.disabled = false;
        }
      });
    }

    init();
  </script>
</body>
</html>
